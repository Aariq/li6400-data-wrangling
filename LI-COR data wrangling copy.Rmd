---
title: "Reading and Wrangling LI-COR data"
output: html_notebook
---

The LI-COR outputs a single text file which is maybe a .xml file (no extension) as well as individual .xls files. They're not really .xls files though.  You need to open them in Excel, then save them as .xlsx.  After that, this script will find them all, extract the data, parse the remarks that are plot, plant, and leaf IDs and put it all into one data frame.

```{r}
library(tidyverse)
library(readxl)
```

```{r}
#folder where the .xlsx files are
data.dir <- "/Users/scottericr/Documents/Tufts/Research Projects/BACE Tea/Photosynthesis Data/relicorpart2"

#a vector of all the paths
(paths <- list.files(data.dir, "*.xlsx") %>% 
  paste0(data.dir, "/", .))

#test one to make sure it works
read_xlsx(paths[1], skip = 7)
```

```{r}
#read all the .xlsx files into a list
raw.list <- paths %>% map(read_xlsx, skip = 7)
raw <- raw.list[[1]]

#function for parsing the data frames created by reading in the .xlsx files  
parse.licor <- function(raw){
  #add column id's to keep track of rows and allow easier joining later
  raw1 <- raw %>% 
  rowid_to_column() 
  
  #this section is for getting sample ID's entered in as remarks.  You'll have to customize based on your system for labeling.
  raw1 %>% 
  filter(Obs == "Remark=") %>% 
  filter(grepl("[[:lower:]]\\s[[:digit:]]", .$HHMMSS)) %>% 
  separate(HHMMSS, into = c("HHMMSS", "plot.id", "plant.id", "leaf"), sep = " ") %>% 
  separate(leaf, into = c("leaf", "trash"), sep ="\"") %>% 
  select(rowid, plot.id, plant.id, leaf) %>% 
  
  #after creating a data frame of just relevant sample ID info and rowid, merge with the original data
  right_join(raw1) %>% 
  
  #then fill all relevant sample ID data down
  fill(plot.id, leaf, plant.id) %>% 
  
  #then remove unnecessary rows and columns
  filter(Obs != "Remark=" & Obs != "in") %>% 
  select(-rowid)
}

#apply tidying function to all data frames
parsed.data <- lapply(raw.list, parse.licor)
```
Great! Now time to row_bind them all into one df.  There might actually be a better function that is specifically designed for simplifying lists.

Sweet!  Now I need to apply that pipeline to all the .xlsx files and then stitch them together with `bind_rows()`

```{r}
data.raw <- bind_rows(parsed.data)

data <- data.raw %>%
  mutate(plot.id = as.factor(plot.id), 
         plant.id = as.factor(plant.id), 
         leaf = as.factor(leaf), 
         Date.Time = as.POSIXct(paste("2017-8-25", .$HHMMSS))) %>%
  select(plot.id, plant.id, leaf, Obs, Date.Time, everything()) %>% 
  select(-HHMMSS) %>% 
  mutate_if(is.character, as.numeric)

data
```

My notes show that I forgot to add a remark for A7 leaf b.  I should be able to tell by the time which belong to b

```{r}
data$leaf[data$Date.Time >= "2017-8-25 09:56:00" & data$Date.Time <= "2017-8-25 09:59:00"] <- "b"
data %>% filter(plot.id == "a" & plant.id == 7)
```
Add treatment info
```{r}
treatments <- read_csv("treatments.csv") %>% mutate_all(as.factor)

data <- right_join(data, treatments, by = c("plot.id" = "Plot")) %>%
  select(Treatment, everything())

data
```



bingo!  write it to a .csv
```{r}
write_csv(data, "photosynthesis data 8-25-2017.csv")
```




